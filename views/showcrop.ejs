<% layout("layouts/boilerplate") %>

<div class="container">
  <h1 class="page-title">
    <i class="bi bi-seedling me-2"></i><%= crop.name %> Details
    <span class="status-dot <%= (crop.active !== false) ? 'active' : 'inactive' %> ms-3"></span>
  </h1>
  
  <!-- Crop Info Card -->
  <div class="crop-info-card mb-4">
    <div class="row justify-content-center">
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-circle" onclick="toggleStatCard(this)">
          <div class="stat-circle-content">
            <i class="bi bi-droplet fs-1"></i>
            <div class="stat-circle-info">
              <h4><%= crop.ph %></h4>
              <small>pH Level</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-circle" onclick="toggleStatCard(this)">
          <div class="stat-circle-content">
            <i class="bi bi-lightning fs-1"></i>
            <div class="stat-circle-info">
              <h4><%= crop.ec %></h4>
              <small>EC Level</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-circle" onclick="toggleStatCard(this)">
          <div class="stat-circle-content">
            <i class="bi bi-thermometer-half fs-1"></i>
            <div class="stat-circle-info">
              <h4><%= crop.temperature %>°C</h4>
              <small>Temperature</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-circle" onclick="toggleStatCard(this)">
          <div class="stat-circle-content">
            <i class="bi bi-clipboard-data fs-1"></i>
            <div class="stat-circle-info">
              <h4><%= reading.length %></h4>
              <small>Readings</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="text-center mt-3">
      <a href="/farm/cropreading/<%= crop._id %>" class="btn btn-success me-2">
        <i class="bi bi-plus-circle me-1"></i>Add Reading
      </a>
      <a href="/farm" class="btn btn-outline-primary">
        <i class="bi bi-house me-1"></i>Back to Dashboard
      </a>
    </div>
  </div>

  <!-- Grafana Dashboard -->
  <div class="grafana-card mb-4">
    <div class="grafana-header">
      <i class="bi bi-graph-up me-3 fs-3"></i>
      <div>
        <h3 class="mb-1">Real-time Analytics</h3>
        <p class="text-muted mb-0">Live sensor data visualization</p>
      </div>
      <div class="time-range-controls">
        <select id="timeRange" class="form-select" onchange="updateTimeRange()">
          <option value="5m">Last 5 minutes</option>
          <option value="15m">Last 15 minutes</option>
          <option value="1h" selected>Last 1 hour</option>
          <option value="6h">Last 6 hours</option>
          <option value="24h">Last 24 hours</option>
          <option value="7d">Last 7 days</option>
          <option value="custom">Custom Range</option>
        </select>
        
        <div id="customRangeInputs" style="display: none; margin-top: 10px;">
          <div class="row g-2">
            <div class="col">
              <input type="datetime-local" id="fromDate" class="form-control form-control-sm" placeholder="From">
            </div>
            <div class="col">
              <input type="datetime-local" id="toDate" class="form-control form-control-sm" placeholder="To">
            </div>
            <div class="col-auto">
              <button type="button" class="btn btn-primary btn-sm" onclick="applyCustomRange()">Apply</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="grafana-container">
      <iframe 
        id="grafanaFrame"
        src="http://192.168.1.200:3000/d-solo/c315cbf9-00ce-4c8d-81b0-1503977250c3/hydroponics-dashboard?orgId=1&from=now-1h&to=now&panelId=1" 
        width="100%" 
        height="400" 
        frameborder="0">
      </iframe>
    </div>
  </div>

  <!-- Readings Table -->
  <div class="readings-card">
    <div class="readings-header">
      <div class="readings-title">
        <i class="bi bi-table me-3 fs-3"></i>
        <div>
          <h2 class="mb-1">Readings for <span class="text-primary"><%= crop.name %></span></h2>
          <p class="text-muted mb-0">Track your crop's progress over time</p>
        </div>
      </div>
      <div class="readings-stats">
        <div class="stat-badge">
          <span class="stat-number"><%= reading.length %></span>
          <span class="stat-label">Total Readings</span>
        </div>
      </div>
    </div>
    
    <% if (reading.length === 0) { %>
      <div class="text-center py-5">
        <i class="bi bi-clipboard-x display-1 text-muted mb-3"></i>
        <h4 class="text-muted">No readings yet</h4>
        <p class="text-muted">Start tracking your crop by adding the first reading</p>
        <a href="/farm/cropreading/<%= crop._id %>" class="btn btn-primary">
          <i class="bi bi-plus-circle me-1"></i>Add First Reading
        </a>
      </div>
    <% } else { %>
      <div class="table-container">
        <div class="table-responsive">
          <table class="table table-hover table-striped" id="readingsTable">
            <thead class="table-success sticky-top">
              <tr>
                <th>Date & Time</th>
                <th>Batch</th>
                <th>pH</th>
                <th>EC</th>
                <th>Temp (°C)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% reading.slice().reverse().forEach(record => { %>
                <tr>
                  <td><%= new Date(record.datetime).toLocaleString() %></td>
                  <td><span class="badge bg-primary"><%= record.batch_no %></span></td>
                  <td><span class="ph-value"><%= record.ph %></span></td>
                  <td><span class="ec-value"><%= record.ec %></span></td>
                  <td><span class="temp-value"><%= record.temperature %>°</span></td>
                  <td>
                    <div class="btn-group" role="group">
                      <a href="/farm/editreading/<%= record._id %>" class="btn btn-sm btn-warning">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <form action="/farm/deletereading/<%= record._id %>?_method=DELETE" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this reading?')">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <div class="pagination-info text-center mt-3">
          <small class="text-muted">Showing latest readings first • Scroll to see more</small>
        </div>
      </div>
    <% } %>
  </div>
</div>

<style>
.stat-circle {
  background: white;
  border: 2px solid rgba(0, 0, 0, 0.1);
  width: 140px;
  height: 140px;
  border-radius: 50%;
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  margin: 0 auto;
}

.stat-circle.expanded {
  width: 280px;
  height: 100px;
  border-radius: 20px;
  flex-direction: row;
  justify-content: space-around;
  padding: 0 15px;
}

.stat-circle:hover {
  transform: translateY(-8px) scale(1.05);
  box-shadow: 0 15px 40px rgba(0,0,0,0.25);
}

.stat-circle:nth-child(1) .bi-droplet {
  color: #17a2b8;
}

.stat-circle:nth-child(2) .bi-lightning {
  color: #ffc107;
}

.stat-circle:nth-child(3) .bi-thermometer-half {
  color: #dc3545;
}

.stat-circle:nth-child(4) .bi-clipboard-data {
  color: #28a745;
}

.stat-circle-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: all 0.3s ease;
}

.stat-circle.expanded .stat-circle-content {
  flex-direction: row;
  align-items: center;
}

.stat-circle-info {
  text-align: center;
}

.stat-circle.expanded .stat-circle-info {
  text-align: left;
  margin-left: 15px;
}

.stat-circle h4 {
  font-size: 1.5rem;
  font-weight: 700;
  color: #333;
  margin: 8px 0 5px 0;
}

.stat-circle.expanded h4 {
  font-size: 1.8rem;
  margin: 0;
}

.stat-circle small {
  color: #666;
  font-weight: 600;
  font-size: 0.75rem;
}

.stat-circle.expanded small {
  font-size: 0.85rem;
}

.stat-circle .fs-1 {
  font-size: 1.8rem !important;
  margin-bottom: 5px;
  transition: all 0.3s ease;
}

.stat-circle.expanded .fs-1 {
  font-size: 2.2rem !important;
  margin-bottom: 0;
  margin-right: 0;
}

.table-container {
  max-height: 700px;
  overflow-y: auto;
  border: none;
  border-radius: 15px;
  background: #f8f9fa;
  padding: 10px;
}

.table th {
  border: none;
  font-weight: 600;
  background: #198754 !important;
  color: white !important;
  position: sticky;
  top: 0;
  z-index: 10;
}

.table td {
  vertical-align: middle;
  padding: 12px 8px;
}

.table-striped > tbody > tr:nth-of-type(odd) > td {
  background-color: rgba(0,0,0,0.02);
}

.ph-value, .ec-value, .temp-value {
  font-weight: 600;
  padding: 4px 8px;
  border-radius: 4px;
  background: #f8f9fa;
}

.btn-group .btn {
  border-radius: 4px !important;
}

.readings-count .badge {
  padding: 8px 12px;
}

.pagination-info {
  background: #f8f9fa;
  padding: 10px;
  border-radius: 0 0 8px 8px;
  margin-top: 0 !important;
}

.status-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display: inline-block;
  box-shadow: 0 0 0 2px white, 0 0 0 3px currentColor;
}

.status-dot.active {
  background-color: #28a745;
  color: #28a745;
}

.status-dot.inactive {
  background-color: #dc3545;
  color: #dc3545;
}

.readings-card {
  background: white;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  padding: 30px;
  margin-top: 20px;
  transition: all 0.3s ease;
}

.readings-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 20px 60px rgba(0,0,0,0.15);
}

.readings-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid #f8f9fa;
}

.readings-title {
  display: flex;
  align-items: center;
}

.readings-title i {
  color: #198754;
  background: rgba(25, 135, 84, 0.1);
  padding: 15px;
  border-radius: 15px;
  margin-right: 20px;
}

.readings-title h2 {
  font-size: 1.8rem;
  font-weight: 700;
  color: #333;
}

.readings-stats {
  text-align: center;
}

.stat-badge {
  background: linear-gradient(135deg, #17a2b8, #138496);
  color: white;
  padding: 20px 25px;
  border-radius: 15px;
  box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
  min-width: 120px;
}

.stat-number {
  display: block;
  font-size: 2rem;
  font-weight: 800;
  line-height: 1;
}

.stat-label {
  display: block;
  font-size: 0.9rem;
  opacity: 0.9;
  margin-top: 5px;
}

.crop-info-card {
  background: white;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  padding: 40px 30px;
  transition: all 0.3s ease;
}

.crop-info-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 20px 60px rgba(0,0,0,0.15);
}

.grafana-card {
  background: white;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  padding: 30px;
  transition: all 0.3s ease;
}

.grafana-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #f8f9fa;
}

.grafana-header i {
  color: #ff6b35;
  background: rgba(255, 107, 53, 0.1);
  padding: 15px;
  border-radius: 15px;
  margin-right: 20px;
}

.time-range-controls {
  min-width: 150px;
}

.time-range-controls .form-select {
  border-radius: 8px;
  border: 1px solid #ddd;
  font-size: 0.9rem;
}

.grafana-container {
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* Fixed Navbar */
.navbar {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  z-index: 1030 !important;
  width: 100% !important;
}

body {
  padding-top: 80px !important;
}

/* Hide navbar search and filter on showcrop page */
.navbar-search,
.navbar-filter {
  display: none !important;
}

@media (max-width: 768px) {
  .table-container {
    max-height: 500px;
  }
  
  .table td, .table th {
    padding: 8px 4px;
    font-size: 0.9rem;
  }
  
  .readings-card {
    padding: 20px;
    margin-top: 15px;
  }
  
  .readings-header {
    flex-direction: column;
    gap: 20px;
    text-align: center;
  }
  
  .readings-title {
    flex-direction: column;
    text-align: center;
  }
  
  .readings-title i {
    margin-right: 0;
    margin-bottom: 15px;
  }
  
  .readings-title h2 {
    font-size: 1.5rem;
  }
  
  .crop-info-card {
    padding: 25px 20px;
  }
}
</style>

<script>
// Stat card toggle functionality
function toggleStatCard(card) {
  // Close all other expanded cards
  document.querySelectorAll('.stat-circle.expanded').forEach(otherCard => {
    if (otherCard !== card) {
      otherCard.classList.remove('expanded');
    }
  });
  
  // Toggle current card
  card.classList.toggle('expanded');
}

// Update Grafana time range
function updateTimeRange() {
  const timeRange = document.getElementById('timeRange').value;
  const iframe = document.getElementById('grafanaFrame');
  const baseUrl = 'http://192.168.1.200:3000/d-solo/c315cbf9-00ce-4c8d-81b0-1503977250c3/hydroponics-dashboard?orgId=1&panelId=1';
  
  if (timeRange === 'custom') {
    document.getElementById('customRangeInputs').style.display = 'block';
    return;
  } else {
    document.getElementById('customRangeInputs').style.display = 'none';
    iframe.src = `${baseUrl}&from=now-${timeRange}&to=now&refresh=10s`;
  }
}

// Apply custom date range
function applyCustomRange() {
  const fromDate = document.getElementById('fromDate').value;
  const toDate = document.getElementById('toDate').value;
  
  if (!fromDate || !toDate) {
    alert('Please select both start and end dates');
    return;
  }
  
  const iframe = document.getElementById('grafanaFrame');
  const baseUrl = 'http://192.168.1.200:3000/d-solo/c315cbf9-00ce-4c8d-81b0-1503977250c3/hydroponics-dashboard?orgId=1&panelId=1';
  const fromTimestamp = new Date(fromDate).getTime();
  const toTimestamp = new Date(toDate).getTime();
  
  iframe.src = `${baseUrl}&from=${fromTimestamp}&to=${toTimestamp}&refresh=10s`;
}
</script>
</style>